<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Link System</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f4; text-align: center; }
        .card { background: white; max-width: 400px; margin: 20px auto; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        button { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .hidden { display: none; }
        #error-log { color: red; margin-top: 10px; font-size: 12px; word-break: break-all; }
        .timer-box { font-size: 24px; font-weight: bold; color: #d35400; margin: 20px 0; }
    </style>
</head>
<body>

    <div id="loading">
        <h3>Connecting to Server...</h3>
    </div>

    <div id="admin-panel" class="hidden">
        <div class="card">
            <h2>Create Link</h2>
            <input type="text" id="longUrl" placeholder="Enter Long URL here...">
            <button id="genBtn">Generate Link</button>
            <div id="resultArea" class="hidden" style="margin-top:15px; background:#e8f5e9; padding:10px;">
                <small>Copy this link:</small>
                <input type="text" id="shortUrl" readonly onclick="this.select()">
            </div>
            <p id="error-log"></p>
        </div>
    </div>

    <div id="download-panel" class="hidden">
        <div class="card">
            <h2>Secure Link</h2>
            <p>Please wait while we verify your connection.</p>
            
            <div class="timer-box">Wait: <span id="timer">10</span>s</div>
            
            <button id="btn-final" class="hidden">GO TO LINK</button>
            <p id="status-msg"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // আপনার কনফিগারেশন (যাচাই করুন এটি সঠিক কিনা)
        const firebaseConfig = {
            apiKey: "AIzaSyBE54MB5e9zAsCr-40sh_rbGU8nwylFI_w",
            authDomain: "mylinkshortener-77ff0.firebaseapp.com",
            projectId: "mylinkshortener-77ff0",
            storageBucket: "mylinkshortener-77ff0.firebasestorage.app",
            messagingSenderId: "219157672598",
            appId: "1:219157672598:web:619402200b2168408e08b7",
            measurementId: "G-WXGKQV6VWJ"
        };

        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            document.getElementById('loading').classList.add('hidden');
        } catch (e) {
            alert("Firebase Error: " + e.message);
            document.getElementById('loading').innerText = "Firebase Config Error!";
        }

        // URL চেক করা (আইডি আছে কি নেই)
        const urlParams = new URLSearchParams(window.location.search);
        const docId = urlParams.get('id');

        if (!docId) {
            // অ্যাডমিন মোড
            document.getElementById('admin-panel').classList.remove('hidden');
        } else {
            // ইউজার মোড
            document.getElementById('download-panel').classList.remove('hidden');
            verifyLink(docId);
        }

        // --- লিঙ্ক তৈরি করা (Create Link) ---
        document.getElementById('genBtn').addEventListener('click', async () => {
            const longUrl = document.getElementById('longUrl').value.trim();
            const btn = document.getElementById('genBtn');
            const errorLog = document.getElementById('error-log');

            if (!longUrl) return alert("URL দিন!");

            btn.innerText = "Processing...";
            btn.disabled = true;
            errorLog.innerText = "";

            try {
                const id = Math.random().toString(36).substring(2, 8);
                // ডাটাবেসে সেভ করা
                await setDoc(doc(db, "links", id), { 
                    original_url: longUrl, 
                    createdAt: new Date().toISOString() 
                });

                // লিঙ্ক দেখানো
                const currentUrl = window.location.href.split('?')[0];
                document.getElementById('shortUrl').value = currentUrl + "?id=" + id;
                document.getElementById('resultArea').classList.remove('hidden');
                btn.innerText = "Generate Another";
            } catch (error) {
                console.error(error);
                errorLog.innerText = "Error: " + error.message + " (Check Firestore Rules)";
                btn.innerText = "Failed";
            }
            btn.disabled = false;
        });

        // --- লিঙ্ক ভেরিফাই এবং টাইমার (Verify Link) ---
        async function verifyLink(id) {
            const statusMsg = document.getElementById('status-msg');
            try {
                const docSnap = await getDoc(doc(db, "links", id));
                
                if (docSnap.exists()) {
                    const finalLink = docSnap.data().original_url;
                    startTimer(finalLink);
                } else {
                    statusMsg.innerText = "Link not found or expired!";
                    statusMsg.style.color = "red";
                    document.querySelector('.timer-box').style.display = 'none';
                }
            } catch (error) {
                statusMsg.innerText = "Connection Failed: " + error.message;
            }
        }

        function startTimer(destination) {
            let time = 10;
            const timerEl = document.getElementById('timer');
            const btn = document.getElementById('btn-final');
            
            const interval = setInterval(() => {
                time--;
                timerEl.innerText = time;
                if (time <= 0) {
                    clearInterval(interval);
                    btn.classList.remove('hidden');
                    btn.onclick = () => window.location.href = destination;
                }
            }, 1000);
        }
    </script>
</body>
</html>
